# NewAnalyzer システム仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**NewAnalyzer** - 株価分析とポートフォリオ最適化のためのWebアプリケーション

### 1.2 プロジェクトの目的
- 株価データの可視化と分析
- ポートフォリオ最適化の支援
- 投資判断のための統計分析ツールの提供

### 1.3 システム構成
- **バックエンド**: FastAPI + Python
- **フロントエンド**: Flutter (Web対応)
- **データプロバイダー**: Yahoo Finance API
- **アーキテクチャ**: RESTful API + クライアント・サーバー構成

## 2. システム要件

### 2.1 開発環境要件
- **Python**: 3.8以上
- **Flutter**: 3.0以上
- **Node.js**: 16以上（オプション）

### 2.2 実行環境要件
- **OS**: Windows 10/11, macOS, Linux
- **メモリ**: 4GB以上推奨
- **ストレージ**: 1GB以上の空き容量
- **ネットワーク**: インターネット接続必須

## 3. 技術スタック

### 3.1 バックエンド技術
```
FastAPI 0.104.1          - Webフレームワーク
Uvicorn 0.24.0           - ASGIサーバー
Pandas 2.1.3             - データ分析・処理
Plotly 5.17.0            - チャート生成
SciPy 1.11.4             - 科学計算
yfinance 0.2.28          - 株価データ取得
NumPy 1.24.3             - 数値計算
```

### 3.2 フロントエンド技術
```
Flutter 3.0+             - UIフレームワーク
syncfusion_flutter_charts - チャート表示
fl_chart 0.66.0          - チャートライブラリ
webview_flutter 4.0.7    - WebView表示
provider 6.1.1           - 状態管理
http 1.1.0               - HTTP通信
```

## 4. システムアーキテクチャ

### 4.1 全体構成
```
┌─────────────────┐    HTTP/REST    ┌─────────────────┐
│   Flutter Web   │ ◄─────────────► │   FastAPI       │
│   Frontend      │                 │   Backend       │
└─────────────────┘                 └─────────────────┘
                                              │
                                              ▼
                                    ┌─────────────────┐
                                    │  Yahoo Finance  │
                                    │     API         │
                                    └─────────────────┘
```

### 4.2 ディレクトリ構造
```
NewAnalyzer/
├── backend/                    # バックエンド
│   ├── api/                   # APIエンドポイント
│   │   ├── analysis_api.py    # 分析API
│   │   ├── chart_api.py       # チャートAPI
│   │   ├── download_api.py    # ダウンロードAPI
│   │   └── portfolio_api.py   # ポートフォリオAPI
│   ├── services/              # ビジネスロジック
│   ├── data_provider/         # データプロバイダー
│   ├── data/                  # データファイル
│   └── main.py               # エントリーポイント
├── frontend/                   # フロントエンド
│   ├── lib/                   # Dartソースコード
│   │   ├── screens/           # 画面
│   │   ├── widgets/           # ウィジェット
│   │   ├── models/            # データモデル
│   │   ├── api/               # API通信
│   │   └── utils/             # ユーティリティ
│   └── pubspec.yaml          # 依存関係
└── setup.py                   # セットアップスクリプト
```

## 5. 機能仕様

### 5.1 チャート機能
#### 5.1.1 ローソク足チャート
- **機能**: 株価の時系列データをローソク足チャートで表示
- **データ**: Open, High, Low, Close, Volume
- **期間**: 日次データ
- **インタラクティブ**: ズーム、パン、ホバー情報表示

#### 5.1.2 テクニカル指標
- **移動平均線**: 単純移動平均（SMA）
- **ボリンジャーバンド**: 標準偏差ベース
- **RSI**: 相対力指数
- **MACD**: 移動平均収束拡散

### 5.2 分析機能
#### 5.2.1 統計サマリー
- **基本統計**: 平均、標準偏差、最小値、最大値
- **リターン計算**: 日次リターン、累積リターン
- **ボラティリティ**: 年率化ボラティリティ
- **シャープレシオ**: リスク調整後リターン

#### 5.2.2 相関分析
- **ペア相関**: 2銘柄間の相関係数
- **相関マトリックス**: 複数銘柄の相関関係
- **ヒートマップ**: 視覚的な相関表示

#### 5.2.3 統合相関分析
- **多変量分析**: 複数銘柄の統合分析
- **主成分分析**: 次元削減と特徴抽出

### 5.3 ポートフォリオ機能
#### 5.3.1 ポートフォリオ最適化
- **最適化手法**: 平均・分散最適化
- **制約条件**: 投資比率の合計=100%
- **目標**: 最大シャープレシオまたは最小リスク

#### 5.3.2 効率的フロンティア
- **リスク・リターン平面**: 効率的な投資組み合わせ
- **最適化曲線**: リスク水準別の最適ポートフォリオ
- **バックテスト**: 過去データでの検証

### 5.4 ダウンロード機能
#### 5.4.1 データ取得
- **プロバイダー**: Yahoo Finance API
- **データ形式**: CSV
- **期間**: カスタマイズ可能
- **銘柄**: 米国株式、ETF、インデックス

#### 5.4.2 バッチ処理
- **複数銘柄**: 一括ダウンロード
- **エラーハンドリング**: 失敗時の再試行
- **進捗表示**: ダウンロード状況の可視化

## 6. API仕様

### 6.1 基本情報
- **ベースURL**: `http://localhost:8000`
- **プロトコル**: HTTP/HTTPS
- **データ形式**: JSON
- **認証**: なし（開発環境）

### 6.2 エンドポイント一覧

#### 6.2.1 ヘルスチェック
```
GET /health
Response: {"status": "healthy"}
```

#### 6.2.2 チャートAPI
```
GET /chart/candlestick/{filename}     # ローソク足データ
GET /chart/html/{filename}            # HTMLチャート
GET /chart/json/{filename}            # JSON形式データ
GET /chart/available-files            # 利用可能ファイル一覧
GET /chart/file-info/{filename}       # ファイル情報
```

#### 6.2.3 ダウンロードAPI
```
POST /download/                       # データダウンロード
GET /download/providers               # プロバイダー一覧
GET /download/provider/{name}/info    # プロバイダー情報
GET /download/search                  # シンボル検索
GET /download/company/{symbol}        # 企業情報
GET /download/files                   # ファイル一覧
GET /download/files/{filename}/info   # ファイル詳細
GET /download/validate/{symbol}       # シンボル検証
```

#### 6.2.4 分析API
```
POST /analysis/summary                # 統計サマリー
POST /analysis/summary/html           # HTML形式サマリー
POST /analysis/correlation            # 相関分析
POST /analysis/correlation/html       # HTML形式相関
POST /analysis/consolidated-correlation # 統合相関分析
```

#### 6.2.5 ポートフォリオAPI
```
POST /portfolio/optimization          # ポートフォリオ最適化
POST /portfolio/optimization/html     # HTML形式最適化
POST /portfolio/efficient-frontier    # 効率的フロンティア
POST /portfolio/efficient-frontier/html # HTML形式フロンティア
```

### 6.3 リクエスト/レスポンス形式

#### 6.3.1 ダウンロードリクエスト
```json
{
  "symbol": "AAPL",
  "start_date": "2023-01-01",
  "end_date": "2023-12-31",
  "provider": "yahoo"
}
```

#### 6.3.2 分析リクエスト
```json
{
  "files": ["AAPL.csv", "MSFT.csv"],
  "analysis_type": "correlation",
  "parameters": {
    "method": "pearson"
  }
}
```

#### 6.3.3 ポートフォリオリクエスト
```json
{
  "files": ["AAPL.csv", "MSFT.csv", "GOOGL.csv"],
  "target_return": 0.10,
  "risk_free_rate": 0.02,
  "optimization_type": "max_sharpe"
}
```

## 7. データ仕様

### 7.1 データ形式
- **ファイル形式**: CSV
- **エンコーディング**: UTF-8
- **区切り文字**: カンマ
- **日付形式**: YYYY-MM-DD

### 7.2 データ構造
```csv
Date,Open,High,Low,Close,Volume
2023-01-01,150.00,152.50,149.80,151.20,1000000
2023-01-02,151.20,153.00,150.50,152.80,1200000
```

### 7.3 データ品質要件
- **欠損値**: 前日値で補完または除外
- **異常値**: 統計的手法で検出・処理
- **データ整合性**: 日付順序の確認

## 8. セキュリティ仕様

### 8.1 認証・認可
- **現状**: 認証なし（開発環境）
- **将来**: JWT認証の実装予定

### 8.2 データ保護
- **入力検証**: 全APIエンドポイントで実装
- **SQLインジェクション**: ORM使用により防止
- **XSS対策**: フロントエンド側でエスケープ処理

### 8.3 CORS設定
```python
CORS(
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)
```

## 9. パフォーマンス仕様

### 9.1 レスポンス時間
- **API応答**: 3秒以内
- **チャート生成**: 5秒以内
- **データダウンロード**: 30秒以内

### 9.2 スループット
- **同時接続数**: 100ユーザー
- **リクエスト/秒**: 50リクエスト

### 9.3 メモリ使用量
- **バックエンド**: 512MB以下
- **フロントエンド**: 256MB以下

## 10. エラーハンドリング

### 10.1 エラーコード
- **200**: 成功
- **400**: バドリクエスト
- **404**: リソース未発見
- **500**: サーバーエラー

### 10.2 エラーレスポンス形式
```json
{
  "error": "エラーメッセージ",
  "detail": "詳細情報",
  "timestamp": "2023-12-01T10:00:00Z"
}
```

## 11. テスト仕様

### 11.1 テスト種別
- **単体テスト**: 各関数・メソッド
- **統合テスト**: APIエンドポイント
- **E2Eテスト**: フロントエンド・バックエンド連携

### 11.2 テストカバレッジ
- **目標**: 80%以上
- **必須**: 重要なビジネスロジック

## 12. デプロイメント仕様

### 12.1 開発環境
- **バックエンド**: `python main.py`
- **フロントエンド**: `flutter run -d chrome`

### 12.2 本番環境（将来）
- **コンテナ化**: Docker
- **オーケストレーション**: Kubernetes
- **CI/CD**: GitHub Actions

## 13. 保守・運用仕様

### 13.1 ログ管理
- **ログレベル**: INFO, WARNING, ERROR
- **ログ形式**: JSON
- **ログ保存期間**: 30日

### 13.2 監視項目
- **サーバー状態**: CPU, メモリ, ディスク
- **API応答時間**: 平均、95パーセンタイル
- **エラー率**: 5%以下

### 13.3 バックアップ
- **データファイル**: 日次バックアップ
- **設定ファイル**: 変更時バックアップ

## 14. 将来拡張計画

### 14.1 短期計画（3ヶ月）
- モバイルアプリ対応
- リアルタイムデータ取得
- アラート機能

### 14.2 中期計画（6ヶ月）
- 機械学習による予測機能
- ソーシャル機能
- 多言語対応

### 14.3 長期計画（1年）
- クラウド展開
- エンタープライズ機能
- APIマーケットプレイス

## 15. 制約事項

### 15.1 技術的制約
- Yahoo Finance APIの利用制限
- ブラウザのWebGL対応が必要
- 大量データ処理時のメモリ制限

### 15.2 法的制約
- 金融商品取引法の遵守
- 個人情報保護法の遵守
- 利用規約の整備

---

**文書情報**
- **作成日**: 2023年12月1日
- **版数**: 1.0
- **作成者**: 開発チーム
- **承認者**: プロジェクトマネージャー
